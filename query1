WITH LEGALACTION AS 
(
        SELECT * FROM (
                SELECT SRC.*, DRV.REC_IND, 
                ROW_NUMBER() OVER (PARTITION BY SRC.POLICYNUMBER,DRV.REC_IND,SRC.LEGALACTIONID ORDER BY SRC.SETTLESUBTYPE ASC) RNUM
                FROM 
               ATLAST_NLZC.DTL_POLICY_DRIVER DRV
                INNER JOIN
                ATLAST_NLZC.T_2V_CLONE_DSLEGALACTION SRC 
                ON DRV.POLICYNUMBER=SRC.POLICYNUMBER
                WHERE PROCESS_ID='HVS_POLICY_MISC_VALUES'
                AND (ENDDATE IS NULL OR ENDDATE > CONVERT(DATETIME, '05/22/2025 00:00:00', 101))
        ) WHERE RNUM = '1'
)

SELECT 
CASE DLTA.REC_IND
 WHEN 'I' THEN 'C'
 ELSE DLTA.REC_IND
END REC_IND,
DLTA.POLICYNUMBER,
DLTA.POLCTRLCODETYPE,
DLTA.POLCTRLCODE,
NULL DEC_VAL,
POLCON.ACTIVEIND,
NULL AS INT_VAL,
CASE WHEN POLCON.POLCTRLCODETYPE='FF' THEN POLCON.CREATEDBY ELSE NULL END AS FREEZE_CREAT_BY
FROM
ATLAST_NLZC.DTL_POLICY_DRIVER DRV
INNER JOIN
ATLAST_NLZC.T_2V_DELTA_DSPOLICYCONTROLCODES DLTA
ON DRV.POLICYNUMBER = DLTA.POLICYNUMBER
AND DRV.PROCESS_ID = 'HVS_POLICY_MISC_VALUES'
LEFT OUTER JOIN 
ATLAST_NLZC.T_2V_CLONE_DSPOLICYCONTROLCODES POLCON
ON POLCON.POLICYNUMBER = DLTA.POLICYNUMBER
and POLCON.POLCTRLCODETYPE= DLTA.POLCTRLCODETYPE
and POLCON.POLCTRLCODE= DLTA.POLCTRLCODE

UNION

SELECT 
DRV.REC_IND,
MISC.POLICYNUMBER,
'CONV_XCHNG_CD',
CAST(MISC.INTVALUE AS VARCHAR),
NULL,
NULL,
NULL,
NULL
FROM
ATLAST_NLZC.DTL_POLICY_DRIVER DRV
INNER JOIN
ATLAST_NLZC.T_2V_CLONE_DSPOLICYMISCVALUE MISC
ON MISC.POLICYNUMBER = DRV.POLICYNUMBER
where PROCESS_ID='HVS_POLICY_MISC_VALUES' 
AND  upper(MISC.VALUEID)='CONVERSION EXCHANGE CODE'

UNION

SELECT 
DRV.REC_IND,
CO.PolicyNumber, 
'AIP_PCRB_AMT', 
'' AS CHAR_VAL,
CL.FaceAmount AS DEC_VAL,
NULL,
NULL,
NULL
FROM
ATLAST_NLZC.DTL_POLICY_DRIVER DRV

INNER JOIN
ATLAST_NLZC.T_2V_CLONE_DSCoverage CO
ON CO.POLICYNUMBER = DRV.POLICYNUMBER
AND CO.COVERAGEID=DRV.COVERAGEID
AND DRV.PROCESS_ID = 'HVS_POLICY_MISC_VALUES'

LEFT JOIN	ATLAST_NLZC.T_2V_CLONE_DSPolicy PO
		ON	PO.POLICYNUMBER = CO.PolicyNumber
LEFT JOIN	ATLAST_NLZC.T_2V_CLONE_DSCoverageLayer CL
		ON	CL.POLICYNUMBER = CO.PolicyNumber
		AND	CL.CoverageID = CO.CoverageID

WHERE	
CO.PRDCOVERAGEID='164'
	AND	CL.LAYERID = '002'
	AND	CL.FaceAmount > 0

UNION

SELECT 
CASE 
WHEN LA.ENDDATE<CONVERT(DATETIME, '05/22/2025 00:00:00', 101) THEN 'D' 
ELSE 'C' 
END as REC_IND,
LA.POLICYNUMBER,
'LGL_ACT_ID',
LA.LEGALACTIONID,
NULL,
NULL,
LA.ACTIVEIND as INT_VAL,
NULL
FROM
LEGALACTION LA



