WITH DRV AS (
	SELECT REC_IND, POLICYNUMBER FROM
	ATLAST_NLZC.DTL_POLICY_DRIVER
	where PROCESS_ID='HVS_POLICY_PREMIUM'
),

H1 AS (
	SELECT * FROM
	(
		SELECT CLONE.POLICYNUMBER, 
		CLONE.EVENTCODE, 
		CLONE.EVENTSEQUENCE,
		CLONE.EVENTAMOUNT,
		ROW_NUMBER() OVER 
		(PARTITION BY CLONE.POLICYNUMBER ORDER BY CLONE.EVENTSEQUENCE DESC) AS RNO
		FROM ATLAST_NLZC.T_2V_CLONE_DSEVENTHISTORY CLONE
		INNER JOIN DRV
		ON DRV.POLICYNUMBER=CLONE.POLICYNUMBER
		AND CLONE.EVENTCODE IN ('P300', 'P340', 'P345', 'P320', 'P350')
	)
	WHERE RNO=1
)

SELECT  
 DRV.POLICYNUMBER
, DRV.REC_IND
, POL.NFOCMBTYPE
, COALESCE(H1.EVENTAMOUNT, 0) AS LAST_LIFE_PREM_AMT
, COALESCE(H2.EVENTAMOUNT, 0) AS LAST_LTC_PREM_AMT
FROM
DRV

LEFT OUTER JOIN
ATLAST_NLZC.T_2V_CLONE_DSPOLICY POL 
ON POL.POLICYNUMBER = DRV.POLICYNUMBER 

LEFT JOIN H1
ON H1.POLICYNUMBER=DRV.POLICYNUMBER

LEFT JOIN
ATLAST_NLZC.T_2V_CLONE_DSEVENTHISTORY H2
ON H2.POLICYNUMBER=DRV.POLICYNUMBER
AND H2.EVENTCODE='P309'
