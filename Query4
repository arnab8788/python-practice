WITH DRV AS
(
	SELECT DISTINCT POLICYNUMBER, REC_IND
	FROM $$SCHEMA_NLZC.DTL_POLICY_DRIVER
	WHERE PROCESS_ID='$$PROCESS_ID'
),

EV_NETAMOUNT AS
(
    SELECT DRV.POLICYNUMBER,
    SUM(NETAMOUNT) as AMOUNT,
    MAX(EFFDATE) AS LAST_UPDATED 
    FROM DRV
    INNER JOIN ATLAST_NLZ.DSEVENTHISTORY EVH
	    ON EVH.POLICYNUMBER=DRV.POLICYNUMBER
	    AND EVENTCODE='A001'
    INNER JOIN ATLAST_NLZ.DSEVENTDETAIL DETAIL
	    ON DETAIL.EVENTSEQUENCE=EVH.EVENTSEQUENCE
	    AND DETAIL.INVESTMENTID IN ('LOANFUND','LoanFund')
	    AND CURRENTRECORD=1
    WHERE EFFDATE BETWEEN FIRST_DAY(TO_DATE('$$JH_CYCLEDATE','MM/DD/YYYY HH24:MI:SS')) AND TO_DATE('$$JH_CYCLEDATE','MM/DD/YYYY HH24:MI:SS')
    GROUP BY DRV.POLICYNUMBER
),


POLV_LOAN AS
(
	SELECT * FROM
	(
		SELECT POLV.POLICYNUMBER, POLV.QUOTESEQ, POLV.EFFDATE, POLV.PARAMCALCDBIND, POLV.LOANCRDTRATE,
		ROW_NUMBER() OVER (PARTITION BY POLV.POLICYNUMBER, POLV.QUOTESEQ ORDER BY POLV.EFFDATE DESC) AS RNO
		FROM $$SCHEMA_NLZ.DSPOLICYVALUE POLV
		INNER JOIN DRV
		ON DRV.POLICYNUMBER=POLV.POLICYNUMBER
		AND POLV.PARAMCALCDBIND='1'
	)
	WHERE RNO='1'
),

EVH AS
(
	SELECT DRV.POLICYNUMBER, DET.NETAMOUNT
	FROM DRV
	INNER JOIN $$SCHEMA_NLZC.T_2V_CLONE_DSEVENTHISTORY EVH
	ON DRV.POLICYNUMBER=EVH.POLICYNUMBER
	AND EVH.EVENTCODE='A640'
	INNER JOIN $$SCHEMA_NLZ.DSEVENTDETAIL DET
	ON EVH.EVENTSEQUENCE=DET.EVENTSEQUENCE
	AND UPPER(TRIM(DET.INVESTMENTID))='LOANFUND'
)

SELECT 
POLV.LOANBALANCE
, POLV.LOANAVAILAMOUNT
, POLV.LOANMAXAMOUNT
, POLV.LOANCHRGRATE
, DRV.REC_IND
, DRV.POLICYNUMBER
, POLV.LOANINTACCR
, EVNT_A.PARENTEVNTSEQ
, EVNT_B.PARENTEVNTSEQ
, ADM.LOANRATETYPE,
CASE
	WHEN TRIM(LOAN.EILOANPROCTYPE)='0' THEN 'Standard Index Loan'
	WHEN TRIM(LOAN.EILOANPROCTYPE)='1' THEN 'Variable Index Loan'
	WHEN TRIM(LOAN.EILOANPROCTYPE)='2' THEN 'Fixed Index Loan'
	ELSE ''
END AS INDX_LOAN_TYPE_IND,
EVH.NETAMOUNT,
POLV_LOAN.LOANCRDTRATE,
EVNT_C.EVENTAMOUNT,
EVNT_C.EVENTDATE,
EVNT_D.EVENTDATE AS LAST_LOAN_DISB_DT
, EV_NETAMOUNT.AMOUNT AS LOAN_ASSET_INT_MTD
,EV_NETAMOUNT.LAST_UPDATED AS LOAN_ASSET_INT_AS_OF_DATE
FROM DRV
LEFT OUTER JOIN $$SCHEMA_NLZC.T_2V_CLONE_DSPOLICYVALUE POLV 
ON POLV.POLICYNUMBER = DRV.POLICYNUMBER 
LEFT OUTER JOIN
(
	SELECT PARENTEVNTSEQ, POLICYNUMBER
	FROM $$SCHEMA_NLZC.T_2V_CLONE_DSEVENTHISTORY
	WHERE EVENTCODE='P300'
) EVNT_A
ON DRV.POLICYNUMBER = EVNT_A.POLICYNUMBER
LEFT OUTER JOIN
(
	SELECT PARENTEVNTSEQ, POLICYNUMBER
	FROM $$SCHEMA_NLZC.T_2V_CLONE_DSEVENTHISTORY
	WHERE EVENTCODE='S522'
) EVNT_B
ON DRV.POLICYNUMBER = EVNT_B.POLICYNUMBER
LEFT OUTER JOIN $$SCHEMA_NLZC.T_2V_CLONE_DSPOLICYLOAN LOAN
ON DRV.POLICYNUMBER=LOAN.POLICYNUMBER
LEFT OUTER JOIN POLV_LOAN
ON DRV.POLICYNUMBER=POLV_LOAN.POLICYNUMBER
LEFT OUTER JOIN EVH
ON DRV.POLICYNUMBER=EVH.POLICYNUMBER
LEFT OUTER JOIN
(
	SELECT POLICYNUMBER, EVENTAMOUNT, EVENTDATE
	FROM $$SCHEMA_NLZC.T_2V_CLONE_DSEVENTHISTORY
	WHERE EVENTCODE='P410'
) EVNT_C
ON DRV.POLICYNUMBER=EVNT_C.POLICYNUMBER
LEFT OUTER JOIN
(
	SELECT POLICYNUMBER, EVENTAMOUNT, EVENTDATE
	FROM $$SCHEMA_NLZC.T_2V_CLONE_DSEVENTHISTORY
	WHERE EVENTCODE='S520'
) EVNT_D
ON DRV.POLICYNUMBER=EVNT_D.POLICYNUMBER
LEFT OUTER JOIN $$SCHEMA_NLZC.T_2V_CLONE_DSADMRULE ADM
ON ADM.POLICYNUMBER =DRV.POLICYNUMBER
LEFT OUTER JOIN EV_NETAMOUNT
ON DRV.POLICYNUMBER=EV_NETAMOUNT.POLICYNUMBER
